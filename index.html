import React, { useRef, useEffect, useState } from "react";
export default function App() {
  const canvasRef = useRef(null);
  const rafRef = useRef(null);
  const agentsRef = useRef([]);
  const [running, setRunning] = useState(true);
  const [count, setCount] = useState(60);
  const [emojiSet, setEmojiSet] = useState("üêô,üêù,ü¶ã,üê¢,üêá");
  const [maxSpeed, setMaxSpeed] = useState(2.2);
  const [perception, setPerception] = useState(60);
  const [separationWeight, setSeparationWeight] = useState(1.6);
  const [alignmentWeight, setAlignmentWeight] = useState(1.0);
  const [cohesionWeight, setCohesionWeight] = useState(1.0);
  const [wrap, setWrap] = useState(true);
  const [emojiSize, setEmojiSize] = useState(26);
  const [backgroundAlpha, setBackgroundAlpha] = useState(0.18);

  useEffect(() => {
    const canvas = canvasRef.current;
    const dpr = window.devicePixelRatio || 1;
    function resize() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
    }
    resize();
    window.addEventListener("resize", resize);
    return () => window.removeEventListener("resize", resize);
  }, []);

  useEffect(() => {
    initAgents(count);
  }, []);

  useEffect(() => {
    agentsRef.current.length = 0;
    initAgents(count);
  }, [count]);

  function rand(min, max) {
    return Math.random() * (max - min) + min;
  }

  function initAgents(n) {
    const canvas = canvasRef.current;
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const emojis = emojiSet.split(",").map(s => s.trim()).filter(Boolean);
    for (let i = 0; i < n; i++) {
      const a = {
        id: Math.random().toString(36).slice(2, 9),
        x: rand(0, w),
        y: rand(0, h),
        vx: rand(-1, 1),
        vy: rand(-1, 1),
        size: emojiSize + rand(-6, 6),
        emoji: emojis[Math.floor(Math.random() * emojis.length)] || "üü¢",
      };
      agentsRef.current.push(a);
    }
  }

  function limit(vx, vy, max) {
    const mag = Math.hypot(vx, vy) || 0.0001;
    if (mag > max) {
      const s = max / mag;
      return [vx * s, vy * s];
    }
    return [vx, vy];
  }

  function step(dt) {
    const canvas = canvasRef.current;
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const agents = agentsRef.current;
    for (let i = 0; i < agents.length; i++) {
      const a = agents[i];
      let steerSepX = 0,
        steerSepY = 0,
        steerAliX = 0,
        steerAliY = 0,
        steerCohX = 0,
        steerCohY = 0;
      let total = 0;
      for (let j = 0; j < agents.length; j++) {
        if (i === j) continue;
        const b = agents[j];
        let dx = b.x - a.x;
        let dy = b.y - a.y;
        const dist = Math.hypot(dx, dy);
        if (dist < 0.0001) continue;
        if (dist < perception) {
          total++;
          steerAliX += b.vx;
          steerAliY += b.vy;
          steerCohX += b.x;
          steerCohY += b.y;
          const diffX = a.x - b.x;
          const diffY = a.y - b.y;
          steerSepX += diffX / (dist * dist);
          steerSepY += diffY / (dist * dist);
        }
      }
      if (total > 0) {
        steerAliX /= total;
        steerAliY /= total;
        steerAliX -= a.vx;
        steerAliY -= a.vy;
        [steerAliX, steerAliY] = limit(steerAliX, steerAliY, 0.05);
        steerCohX = steerCohX / total - a.x;
        steerCohY = steerCohY / total - a.y;
        [steerCohX, steerCohY] = limit(steerCohX, steerCohY, 0.04);
        [steerSepX, steerSepY] = limit(steerSepX, steerSepY, 0.15);
      }

      a.vx += steerSepX * separationWeight + steerAliX * alignmentWeight + steerCohX * cohesionWeight;
      a.vy += steerSepY * separationWeight + steerAliY * alignmentWeight + steerCohY * cohesionWeight;
      [a.vx, a.vy] = limit(a.vx, a.vy, maxSpeed);
      a.x += a.vx * dt;
      a.y += a.vy * dt;

      if (wrap) {
        if (a.x < -a.size) a.x = w + a.size;
        if (a.x > w + a.size) a.x = -a.size;
        if (a.y < -a.size) a.y = h + a.size;
        if (a.y > h + a.size) a.y = -a.size;
      } else {
        if (a.x < 0) { a.x = 0; a.vx *= -0.8 }
        if (a.x > w) { a.x = w; a.vx *= -0.8 }
        if (a.y < 0) { a.y = 0; a.vy *= -0.8 }
        if (a.y > h) { a.y = h; a.vy *= -0.8 }
      }
    }
  }

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext("2d");
    let last = performance.now();
    function render(now) {
      const dt = Math.min((now - last) / 16.6667, 4);
      last = now;
      if (running) step(dt);
      ctx.fillStyle = `rgba(10,10,12,${backgroundAlpha})`;
      ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight);
      ctx.font = `${emojiSize}px serif`;
      const agents = agentsRef.current;
      for (let i = 0; i < agents.length; i++) {
        const a = agents[i];
        ctx.save();
        ctx.translate(a.x, a.y);
        ctx.fillText(a.emoji, 0, 0);
        ctx.restore();
      }
      rafRef.current = requestAnimationFrame(render);
    }
    rafRef.current = requestAnimationFrame(render);
    return () => cancelAnimationFrame(rafRef.current);
  }, [running, emojiSize, backgroundAlpha, maxSpeed, perception, separationWeight, alignmentWeight, cohesionWeight, wrap]);

  function toggleRun() {
    setRunning(r => !r);
  }

  function clearAgents() {
    agentsRef.current = [];
  }

  function addAgents(n) {
    const canvas = canvasRef.current;
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    const emojis = emojiSet.split(",").map(s => s.trim()).filter(Boolean);
    for (let i = 0; i < n; i++) {
      agentsRef.current.push({
        id: Math.random().toString(36).slice(2, 9),
        x: rand(0, w),
        y: rand(0, h),
        vx: rand(-1, 1),
        vy: rand(-1, 1),
        size: emojiSize + rand(-6, 6),
        emoji: emojis[Math.floor(Math.random() * emojis.length)] || "üîµ",
      });
    }
  }

  return (
    <div className="min-h-screen flex flex-col" style={{ fontFamily: 'Inter, system-ui, sans-serif' }}>
      <div style={{ padding: 12, display: 'flex', gap: 12, alignItems: 'center', background: 'linear-gradient(90deg,#0f172a,#021025)', color: '#e6eef8' }}>
        <div style={{ fontWeight: 700, fontSize: 18 }}>√âmergence ‚Äî interface</div>
        <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
          <button onClick={toggleRun} style={{ padding: '6px 10px', borderRadius: 8, background: '#0ea5a5', color: '#012' }}>{running ? 'Pause' : 'Lancer'}</button>
          <button onClick={() => { clearAgents(); initAgents(count); }} style={{ padding: '6px 10px', borderRadius: 8, background: '#7c3aed', color: '#fff' }}>R√©initialiser</button>
          <button onClick={() => addAgents(10)} style={{ padding: '6px 10px', borderRadius: 8, background: '#ef4444', color: '#fff' }}>+10</button>
        </div>
        <div style={{ marginLeft: 'auto', display: 'flex', gap: 8, alignItems: 'center' }}>
          <label style={{ fontSize: 13 }}>Agents</label>
          <input type="range" min="10" max="500" value={count} onChange={e => setCount(Number(e.target.value))} />
          <label style={{ fontSize: 13 }}>{count}</label>
        </div>
      </div>

      <div style={{ display: 'flex', gap: 12, padding: 12, alignItems: 'flex-start' }}>
        <div style={{ flex: 1, borderRadius: 12, overflow: 'hidden', boxShadow: '0 6px 18px rgba(2,6,23,0.6)' }}>
          <canvas ref={canvasRef} style={{ width: '100%', height: '70vh', display: 'block', background: '#071126' }} />
        </div>

        <div style={{ width: 320, padding: 12, borderRadius: 12, background: '#00121b', color: '#cfe8ff' }}>
          <div style={{ marginBottom: 8, fontWeight: 700 }}>Contr√¥les</div>
          <div style={{ display: 'grid', gap: 8 }}>
            <div>
              <label>Jeux d'emojis (s√©par√©s par ,)</label>
              <input value={emojiSet} onChange={e => setEmojiSet(e.target.value)} style={{ width: '100%', padding: 6, borderRadius: 6 }} />
            </div>
            <div>
              <label>Vitesse max {maxSpeed.toFixed(2)}</label>
              <input type="range" min="0.2" max="6" step="0.01" value={maxSpeed} onChange={e => setMaxSpeed(Number(e.target.value))} style={{ width: '100%' }} />
            </div>
            <div>
              <label>Perception {perception}</label>
              <input type="range" min="20" max="240" value={perception} onChange={e => setPerception(Number(e.target.value))} style={{ width: '100%' }} />
            </div>
            <div>
              <label>S√©paration {separationWeight.toFixed(2)}</label>
              <input type="range" min="0" max="3" step="0.01" value={separationWeight} onChange={e => setSeparationWeight(Number(e.target.value))} style={{ width: '100%' }} />
            </div>
            <div>
              <label>Alignement {alignmentWeight.toFixed(2)}</label>
              <input type="range" min="0" max="3" step="0.01" value={alignmentWeight} onChange={e => setAlignmentWeight(Number(e.target.value))} style={{ width: '100%' }} />
            </div>
            <div>
              <label>Coh√©sion {cohesionWeight.toFixed(2)}</label>
              <input type="range" min="0" max="3" step="0.01" value={cohesionWeight} onChange={e => setCohesionWeight(Number(e.target.value))} style={{ width: '100%' }} />
            </div>
            <div>
              <label>Taille emoji {emojiSize}px</label>
              <input type="range" min="12" max="64" value={emojiSize} onChange={e => setEmojiSize(Number(e.target.value))} style={{ width: '100%' }} />
            </div>
            <div>
              <label>Tra√Æn√©e d'arri√®re-plan {backgroundAlpha.toFixed(2)}</label>
              <input type="range" min="0" max="0.7" step="0.01" value={backgroundAlpha} onChange={e => setBackgroundAlpha(Number(e.target.value))} style={{ width: '100%' }} />
            </div>
            <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
              <label>Rebond / Wrap</label>
              <button onClick={() => setWrap(w => !w)} style={{ padding: '6px 8px', borderRadius: 6 }}>{wrap ? 'Wrap' : 'Rebond'}</button>
              <button onClick={() => { agentsRef.current = []; initAgents(count); }} style={{ padding: '6px 8px', borderRadius: 6 }}>R√©initialiser agents</button>
            </div>
            <div style={{ display: 'flex', gap: 8 }}>
              <button onClick={() => addAgents(5)} style={{ padding: '8px', borderRadius: 8 }}>Ajouter 5</button>
              <button onClick={() => addAgents(20)} style={{ padding: '8px', borderRadius: 8 }}>Ajouter 20</button>
              <button onClick={() => { agentsRef.current = []; }} style={{ padding: '8px', borderRadius: 8 }}>Supprimer</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
